---
title: "03 Manipulating Phylogenetic Tree"
author: "Katie Heineman"
date: "6/21/2019"
output: html_document
---

# Read in Data & Tree Created in File 02_PhylogeneticTreeBuilding

```{r setup, include=FALSE}
library(ape)
library(data.table)
library(phytools)
library(stringr)

infraTree <- read.tree("Data/californiaTreewithInfraSpecies.tre")
sppOnly <- read.tree("Data/result_california_speciesOnly.tre")
accDat <- fread("Data/tblAccessionsCAPR_2019-Jun-21_1829.csv",na.strings=c("",NA,"NA"))
# Generated from script in 02
spp <- fread("Data/spp_withNameOnPhylogeny.csv")
cnps <- fread("Data/tblCNPSRanks_2019-Jun-21_1830.csv")
```

# Data Summary
```{r summary}
## Summarize Accession Data by JepID to find the following variables
# Total Seed Count
# Total Seed Collections
# Total Accessions
# Total unique Cnddb EO indices

accDat[,organismQuantity:=as.numeric(organismQuantity)]

# Merge summary onto species and CNPS
AccwithSpp <- merge(spp,accDat,by.y="taxonID",by.x="JepID",all.x=T)
AccwithSpp <- merge(AccwithSpp,cnps,by="JepID",all.x=T)


summAcc <- AccwithSpp[,.(collectionTypes=toString(sort(unique(basisofRecord))),totalSeed=sum((organismQuantity),na.rm=T), totalSeedCollections=sum(1*(basisofRecord=="Seed")),totalColl=.N, 
uniqueEOs = toString(unique(cnddbEOIndex)),family=family[1],genus=genus[1]),by="nameOnPhylogeny"]
summAcc[,uniqueEOs:=ifelse(uniqueEOs=="NA", 0,str_count(uniqueEOs,",")+1)]

summAcc[!(nameOnPhylogeny%in%infraTree$tip.label),.(nameOnPhylogeny,family,genus)][order(nameOnPhylogeny)]

pruned.treeAdiantum<-drop.tip(infraTree,infraTree$tip.label[-which(grepl("Adiantum",infraTree$tip.label))])
plot(pruned.treeAdiantum)

pruned.treeAnomobryum<-drop.tip(infraTree,infraTree$tip.label[-which(grepl("Quercus",infraTree$tip.label))])
plot(pruned.treeAnomobryum)



```


# Match Traits to Tree

```{r matching traits to tree}

# Making a matrix
trait_matrix <- as.matrix(summAcc[,.(collectionTypes,totalSeed,totalSeedCollections,totalColl)])
rownames(trait_matrix) <- summAccwithSpp$tip.label

# Ensuring trait matrix order matches the phylogenetic tree order 
trait_matrix <- trait_matrix[infraTree$tip.label,]

# Creating a data object that matches the tree and the traits (only including T50 and GP)
MatchDataObj= match.phylo.data(phy_coll3, trait_matrix[,c(1,2,5,6)])


```

# Filtering by Traits